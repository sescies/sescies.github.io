<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>登入</title>
  <!--<meta name="description" content="">-->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/admin/login.html">
  <link rel="alternate" type="application/rss+xml" title="SESCies" href="/feed.xml">
  <!--custom css-->
  <link rel="stylesheet" href="/assets/main-style.css">
  <link rel="stylesheet" href="/assets/style.css">
  <link rel="stylesheet" href="/assets/table.css">
  <!--prism-->
  <link rel="stylesheet" href="/assets/prism/prism.css">
  <!--uikit css-->
  <link rel="stylesheet" href="/assets/uikit/css/uikit.min.css">

  <!--jquery-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <!--<script src="/assets/js/jquery-3.1.1.min.js"></script>-->

  <!--uikit javascript-->
  <!--<script src="/assets/uikit/js/uikit.min.js"></script>
  <script src="/assets/uikit/js/uikit-icons.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.18/js/uikit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.18/js/uikit-icons.min.js"></script>

  

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
</head>


  <body>
    <div id="fb-root"></div>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '276121856143098',
      cookie     : true,
      xfbml      : true,
      version    : 'v2.8'
    });
    FB.AppEvents.logPageView();
    FB.getLoginStatus(function(response) {
      statusChangeCallback(response);
    });
    FB.Event.subscribe('auth.statusChange', function(response) {
      if(response.session){
        statusChangeCallback(response);
       }else{
         statusChangeCallback(response);
       }
     });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/zh_TW/sdk/debug.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>


    <div class="header">
  <div class="uk-container">
    <div class="uk-navbar">
      <div class="uk-navbar-left">
        <a class="site-title" href="/">SESCies</a>
      </div>
      <div class="uk-navbar-right">
        <ul class="uk-navbar-nav">
          <li class="uk-active">
            <a href="../admin/login.html">登入</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>


    <div class="content">
      <div class="uk-container">
        <div style="margin-top:15%;">
          <div id="loginDiv" style="text-align:center;display:none;">
            <h3>使用Facebook登入</h3>
            <button class="uk-button uk-button-primary uk-button-large" onclick="fbLogin();"><li uk-icon="icon: facebook;"></li>登入</button>
          </div>
          <div id="regDiv" style="text-align:center;display:none;">
            <h3>尚未申請會員</h3>
            <p><button class="uk-button uk-button-primary uk-button-large" onclick="register();"><li uk-icon="icon: facebook;"></li>使用Facebook帳號申請</button></p>
            <p><button class="uk-button uk-button-default uk-button-large" onclick="window.location='../';">回首頁</button></p>
            <p><div class="fb-login-button" data-max-rows="1" data-size="large" data-show-faces="false" data-auto-logout-link="true"></div></p>
          </div>
          <div id="regedDiv" style="text-align:center;display:none;">
            <h2>註冊申請已送出</h2>
            <h3>正在等候審核</h3>
            <p><button class="uk-button uk-button-primary uk-button-large" onclick="window.location='../';">回首頁</button></p>
            <p><div class="fb-login-button" data-max-rows="1" data-size="large" data-show-faces="false" data-auto-logout-link="true"></div></p>
          </div>
          <div id="context" style="text-align:center;display:none;">

          </div>
          <div id="loadingDiv" style="text-align:center;">
            <?xml version="1.0" encoding="utf-8"?><svg width='200px' height='200px' xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="uil-facebook"><rect x="0" y="0" width="100" height="100" fill="#ffffff" class="bk"></rect><g transform="translate(20 50)"><rect x="-10" y="-30" width="20" height="60" fill="#3769c8" opacity="0.6"><animateTransform attributeName="transform" type="scale" from="2" to="1" begin="0s" repeatCount="indefinite" dur="1s" calcMode="spline" keySplines="0.1 0.9 0.4 1" keyTimes="0;1" values="2;1"></animateTransform></rect></g><g transform="translate(50 50)"><rect x="-10" y="-30" width="20" height="60" fill="#3769c8" opacity="0.8"><animateTransform attributeName="transform" type="scale" from="2" to="1" begin="0.1s" repeatCount="indefinite" dur="1s" calcMode="spline" keySplines="0.1 0.9 0.4 1" keyTimes="0;1" values="2;1"></animateTransform></rect></g><g transform="translate(80 50)"><rect x="-10" y="-30" width="20" height="60" fill="#3769c8" opacity="0.9"><animateTransform attributeName="transform" type="scale" from="2" to="1" begin="0.2s" repeatCount="indefinite" dur="1s" calcMode="spline" keySplines="0.1 0.9 0.4 1" keyTimes="0;1" values="2;1"></animateTransform></rect></g></svg>
          </div>
        </div>
      </div>
    </div>

    <div class="footer uk-light">
      <div class="uk-container">
        <div style="height:10px;"></div>
        <ul class="uk-subnav uk-subnav-divider">
          <li><a target="_blank" href="#" uk-icon="icon: facebook; ratio: 2"></a></li>
          <li><a target="_blank" href="https://github.com/sescies" uk-icon="icon: github; ratio: 2"></a></li>
        </ul>
        <div class="uk-grid-match uk-child-width-1-2@m" uk-grid>
          <div>
            <h3>關於</h3>
            <ui>
              <li>By Li-Xian Chen @ NIU CSIE</li>
              <li>使用創用CC授權 (By-NC)</li>
              <li>
                <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc/3.0/tw/"><img alt="創用 CC 授權條款" style="border-width:0" src="/assets/images/cc.png" /></a>
              </li>
            </ui>
          </div>

          <div>
            <h3 style="color:#fff;">技術</h3>
            <ui>
              <li>以 <a href="https://jekyllrb.com/" target="_blank">Jekyll</a> 為基底開發</li>
              <li>CSS採用 <a href="https://getuikit.com/" target="_blank">UIkit3</a> 配置</li>
              <li>最低支援至Internet Explorer 10</li>
            </ui>
          </div>
          <div>

          </div>
        </div>
        <br/>
      </div>
    </div>

    <script src="/assets/prism/prism.js"></script>


    <script language="javascript">
  function fbLogin(){
    FB.login(function(response){
      statusChangeCallback(response);
    }, {scope: 'public_profile,email'});
  }

  function fbLogout(){
    FB.logout(function(){
      statusChangeCallback(null);
    });
  }
</script>

    <script language="javascript">
      function switchTo(pattern){
        var patterns = ["loginDiv", "regDiv", "regedDiv", "context", "loadingDiv"];
        for(var i = 0; i < patterns.length; i++){
          if(pattern == patterns[i]){
            $("#"+patterns[i]).show();
          }else{
            $("#"+patterns[i]).hide();
          }
        }
      }


      function statusChangeCallback(response){
        console.log(response);
        if(response !== null && response.status === 'connected'){
          $.ajax({
             url: "https://script.google.com/macros/s/AKfycbwTO6bb061ID-B-rXF4Agxr8qpAcZjLDO0LVKrewfEsZOV1Yd5P/exec",
             type: 'GET',
             data: {
               "token" : response.authResponse.accessToken,
               "action" : "login",
             },
              error: function(xhr) {
                console.error('Ajax request 發生錯誤');
                switchTo('context');
                $('#context').html('<div style="text-align:center;"><h2>伺服器錯誤!</h2><h3>發生錯誤...重新整理試試?</h3></div>');
              },
              success: function(response) {
                var json = JSON.parse(response);
                console.log(json);
                if(json.isAccepted === true){
                  switchTo('loadingDiv');
                  window.location.replace("./");
                }else{
                  if(json.isRegistered){
                    switchTo('regedDiv');
                  }else{
                    switchTo('regDiv');
                  }
                }
              }
            });
        }else{
          switchTo('loginDiv');
        }
      }

      function register(){
        switchTo('loadingDiv');
        FB.getLoginStatus(function(response) {
          $.ajax({
             url: "https://script.google.com/macros/s/AKfycbwTO6bb061ID-B-rXF4Agxr8qpAcZjLDO0LVKrewfEsZOV1Yd5P/exec",
             type: 'GET',
             data: {
               "token" : response.authResponse.accessToken,
               "action" : "register",
             },
              error: function(xhr) {
                console.error('Ajax request 發生錯誤');
                switchTo('context');
                $('#context').html('<div style="text-align:center;"><h2>伺服器錯誤!</h2><h3>發生錯誤...重新整理試試?</h3></div>');
              },
              success: function(response) {
                if(response === "true"){
                  switchTo('regedDiv');
                }else if(response === "false"){
                  $('#context').html('<div style="text-align:center;"><h2>伺服器錯誤!</h2><h3>發生錯誤...重新整理試試?</h3></div>');
                  switchTo('context');
                }else{
                  var json = JSON.parse(response);
                  if(json.isAccepted === true){
                    switchTo('loadingDiv');
                    window.location.replace("./");
                  }else{
                    if(json.isRegistered){
                      switchTo('regedDiv');
                    }else{
                      switchTo('regDiv');
                    }
                  }
                }
              }
            });
        });
      }
    </script>
  </body>

</html>
